%%%% -*- Mode: LaTeX -*-
%%
%% This is the draft of the 2nd part of EXPRESS/SOS 2018 paper, coauthored by
%% Prof. Davide Sangiorgi and Chun Tian.

\subsection{Bisimulation and Bisimilarity}
\label{ss:bb}

A highlight of this CCS formalisation is the simplified definitions of
bisimilarities using the new coinduction package of
HOL4. Without this package, bisimilarities % I&C editor issue 6
can still be defined in HOL, but
proving their properties would be more tedious and
complicated~\citep[p.~91]{Mil89}.
Below we briefly describe how weak bisimulation and weak
bisimilarity are defined in HOL.
Strong bisimulation and strong bisimilarity, as well as other
concepts such as expansion and contraction, can be defined
in the same manner.

To define (weak) bisimilarity, first we need to define
weak transitions of CCS processes.
A (possibly empty) sequence of $\tau$-transitions between
two processes is defined as a new binary relation \HOLtm{EPS}
($\overset{\epsilon}{\Longrightarrow}$), which is the
reflexive and transitive closure (RTC, denoted by a superscript $^*$)
of ordinary $\tau$-transitions of CCS processes:
\begin{alltt}
\HOLthm[def,>>3]{WeakEQ.EPS_def}\hfill{[EPS_def]}
\end{alltt}
Then we can define a weak transition as an ordinary transition wrapped by
two $\epsilon$-transitions:
\begin{alltt}
\HOLthm[def,>>3]{WeakEQ.WEAK_TRANS}\hfill{[WEAK_TRANS]}
\end{alltt}
%
The definition of weak bisimulation is then based on weak and $\epsilon$--transitions:
\begin{alltt}
\HOLthm[def,>>3]{WeakEQ.WEAK_BISIM}\hfill{[WEAK_BISIM]}
\end{alltt}

We can prove, for example, that the identity relation (\HOLtm[m;!]{(\x y. x = y)})
is indeed a bisimulation, and that
bisimulation is preserved by inversion, composition, and union operations.
Weak bisimilarity can be then defined in HOL4 by the following code:
\begin{lstlisting}
CoInductive WEAK_EQUIV :
    !(E :('a, 'b) CCS) (E' :('a, 'b) CCS).
       (!l.
         (!E1. TRANS E  (label l) E1 ==>
               (?E2. WEAK_TRANS E' (label l) E2 /\ WEAK_EQUIV E1 E2)) /\
         (!E2. TRANS E' (label l) E2 ==>
               (?E1. WEAK_TRANS E  (label l) E1 /\ WEAK_EQUIV E1 E2))) /\
       (!E1. TRANS E  tau E1 ==> (?E2. EPS E' E2 /\ WEAK_EQUIV E1 E2)) /\
       (!E2. TRANS E' tau E2 ==> (?E1. EPS E  E1 /\ WEAK_EQUIV E1 E2))
      ==> WEAK_EQUIV E E'
End
\end{lstlisting}
Like the case of \HOLtm{TRANS}, the successful invocation of the
coinductive definitional principle returns three
theorems (\texttt{WEAK_EQUIV_rules}, \texttt{WEAK_EQUIV_coind} and
\texttt{WEAK_EQUIV_cases}):
\begin{itemize}
\item \texttt{WEAK_EQUIV_rules} is the same as the input term, which now becomes a theorem:
\begin{alltt}
\HOLthm[]{WeakEQ.WEAK_EQUIV_rules}
\end{alltt}
\item \texttt{WEAK_EQUIV_coind} is the coinduction principle for \HOLtm{WEAK_EQUIV} ($\wb$):
\begin{alltt}
\HOLthm[]{WeakEQ.WEAK_EQUIV_coind}
\end{alltt}
\item \texttt{WEAK_EQUIV_cases} is the so-called `cases' or `inversion' theorem for
  the relations, and is used to decompose an element in the relation into the possible ways of
  obtaining it by the rules:
\begin{alltt}
\HOLthm[]{WeakEQ.WEAK_EQUIV_cases}
\end{alltt}
\end{itemize}

The coinduction principle \texttt{WEAK_EQUIV_coind} says that any
bisimulation is contained in the resulting relation.
The purpose of \texttt{WEAK_EQUIV_cases} is to
further assert that such resulting relation is indeed a
fixed point. Thus \texttt{WEAK_EQUIV_coind} and \texttt{WEAK_EQUIV_cases}
together make sure that bisimilarity is the greatest fixed point.

The original definition of \texttt{WEAK_EQUIV} now becomes a theorem:
\begin{alltt}
\HOLthm{WeakEQ.WEAK_EQUIV}\hfill{[WEAK_EQUIV]}
\end{alltt}

The formal definition of rooted bisimilarity ($\rapprox$, \texttt{OBS_CONGR}) 
is not recursive and follows Definition~\ref{d:rootedBisimilarity}:
\begin{alltt}
\HOLthm[def,>>3]{ObsCongr.OBS_CONGR}\hfill{[OBS_CONGR]}
\end{alltt}
Below is the formal version of Lemma~\ref{l:obsCongrByWeakBisim}
(\texttt{OBS_CONGR_BY_WEAK_BISIM}), which is needed later, in the proof
of Theorem~\ref{t:rcontraBisimulationU}:
\begin{alltt}
\HOLthm{ObsCongr.OBS_CONGR_BY_WEAK_BISIM}
\end{alltt}

Finally, on the relationship between (weak) bisimilarity and rooted bisimilarity, 
we have proved Deng's Lemma and Hennessy's Lemma
(Lemma 4.1 and 4.2 of~\citep[p.~176,~178]{Gorrieri:2015jt}):
\begin{alltt}
\HOLthm[nosp]{CoarsestCongr.DENG_LEMMA}\hfill{[DENG_LEMMA]}
  
\HOLthm[nosp]{CoarsestCongr.HENNESSY_LEMMA}\hfill{[HENNESSY_LEMMA]}
\end{alltt}
These are useful results in the theory of CCS (though we will not need them in the
  remainder of the paper).

\subsection{Algebraic Laws}
\label{ss:alaws}

Having formalised the definitions of strong bisimulation and strong bisimilarity,
we can derive \emph{algebraic laws} for the 
 bisimilarities. We only report a few algebraic laws on summation:
\begin{alltt}
STRONG_SUM_IDEMP:          \HOLthm{StrongLaws.STRONG_SUM_IDEMP}  
STRONG_SUM_COMM:           \HOLthm{StrongLaws.STRONG_SUM_COMM}
STRONG_SUM_IDENT_L:        \HOLthm{StrongLaws.STRONG_SUM_IDENT_L}
STRONG_SUM_IDENT_R:        \HOLthm{StrongLaws.STRONG_SUM_IDENT_R}
STRONG_SUM_ASSOC_R:        \HOLthm{StrongLaws.STRONG_SUM_ASSOC_R}
STRONG_SUM_ASSOC_L:        \HOLthm{StrongLaws.STRONG_SUM_ASSOC_L}
STRONG_SUM_MID_IDEMP:      \HOLthm{StrongLaws.STRONG_SUM_MID_IDEMP}
STRONG_LEFT_SUM_MID_IDEMP: \HOLthm{StrongLaws.STRONG_LEFT_SUM_MID_IDEMP}
\end{alltt}

% Not all above theorems are primitive (in the sense of providing a
% minimal axiomatization set for proving all other strong algebraic
% laws). 
The first five of them are proven by constructing appropriate bisimulations,
and their formal proofs are written in
a goal-directed manner~\citep[Chapter 4]{holdesc}. In contrast, the % editorial
last three algebraic laws are derived in a forward manner by applications of
previous proven laws (without directly using the SOS
inference rules and the definition of bisimulation).
 These algebraic laws also hold for weak bisimilarity and rooted
  bisimilarity, as these are coarser than strong bisimilarity. 
For weak bisimilarity and rooted bisimilarity, the following algebraic
laws, called $\tau$-laws, hold:
\begin{alltt}
TAU1:      \HOLthm{ObsCongrLaws.TAU1}
TAU2:      \HOLthm{ObsCongrLaws.TAU2}
TAU3:      \HOLthm{ObsCongrLaws.TAU3}
TAU_STRAT: \HOLthm{CoarsestCongr.TAU_STRAT}
TAU_WEAK:  \HOLthm{WeakLaws.TAU_WEAK}
\end{alltt}

\subsection{Expansion, Contraction and Rooted Contraction}

We formalise and contraction along the lines of strong and weak bisimilarity:
\begin{alltt}
\HOLthm[def,>>3]{Expansion.EXPANSION}\hfill{[EXPANSION]}

\HOLthm{Expansion.expands_thm}\hfill{[expands_thm]}

\HOLthm[def,>>3]{Contraction.CONTRACTION}\hfill{[CONTRACTION]}

\HOLthm{Contraction.contracts_thm}\hfill{[contracts_thm]}
\end{alltt}

The contraction preorder ($\mcontrBIS$) contains the expansion
preorder ($\expa$), and they are both contained in weak bisimilarity ($\wb$):
\begin{proposition}{(Relationships between contraction preorder,
    expansion preorder and weak bisimilarity)}
\begin{enumerate}
\item (Expansion preorder implies contraction preorder)
\begin{alltt}
\HOLthm[nosp]{Contraction.expands_IMP_contracts}\hfill[expands_IMP_contracts]
\end{alltt}
\item (Contraction preorder implies weak bisimilarity)
\begin{alltt}
\HOLthm[nosp]{Contraction.contracts_IMP_WEAK_EQUIV}\hfill[contracts_IMP_WEAK_EQUIV]
\end{alltt}
\end{enumerate}
\end{proposition}

The proofs of properties for contraction are
generally harder than those for expansion. This is mostly due to the fact
  that, although the contraction preorder ($\mcontrBIS$) is contained in
  bisimilarity ($\wb$), a contraction need not be a bisimulation.
  In another words, the following proposition does not hold:
\begin{alltt}
\HOLtm[>>3]{!Con. CONTRACTION Con ==> WEAK_BISIM Con}
\end{alltt}
However it does hold that, if $\R$ is a contraction, then
 $\R\;\cup \wb$ is a bisimulation.
For instance, we can prove \texttt{contracts_IMP_WEAK_EQUIV}
 by constructing a bisimulation \HOLtm{Wbsm} containing two processes
$P$ and $Q$, given that they are in $Con$ (a contraction):
\begin{alltt}
        \HOLtm{?Wbsm. Wbsm P Q /\ WEAK_BISIM Wbsm}
   ------------------------------------
    0.  \HOLtm{Con P Q}
    1.  \HOLtm{CONTRACTION Con}
\end{alltt}
To complete the proof, one cannot choose $Con$ for $Wbsm$ and
show that $Con$ itself is a bisimulation, but rather
that $Con\;\cup\!\wb$ is a bisimulation.
In contrast, in the corresponding lemma for expansion 
one can just take $Con$.
%
Finally, the rooted contraction ($\rcontr$) is formalised as follows:
\begin{alltt}
\HOLthm[def,>>3]{Contraction.OBS_contracts}\hfill{[OBS_contracts]}
\end{alltt}

\subsection{The formalisation of ``bisimulation up to''}

``Bisimulation up to'' is a family of powerful proof techniques
for reducing the sizes of relations needed for defining bisimulations~\cite{PousS19}.
By definition, two processes are bisimilar iff there exists a
bisimulation relation containing them. However, in practice
this definition is sometimes  hard to apply. Instead, to reduce
the sizes of the exhibited relations, one prefers to define relations
which are bisimulations only when closed up under some specific and
privileged relation, so to relieve the needed proof work. These
techniques are usually called \emph{``up-to'' techniques}.

Recall that we often write $P \;\R\; Q$ to denote
$(P, Q) \in \R$ for any binary relation $\R$. 
Moreover, 
 $\sim \mathcal{S} \sim$ is the composition of three binary
relations: $\sim$, $\S$ and $\sim$. Hence $P \sim \S \sim Q$ means that
there exist $P'$ and $Q'$ such that $P \sim P'$, $P' \;\S\; Q'$ and $Q' \sim Q$.
\begin{definition}%[Bisimulation up to $\sim$]
  \label{def:bisimUptoSim}
$\S$ is a ``bisimulation up to $\sim$'' if $P\ \S\ Q$ implies, for all $\mu$,
\begin{enumerate}
\item Whenever $P \overset{\mu}{\rightarrow} P'$ then, for some
  $Q'$, $Q \overset{\mu}{\rightarrow} Q'$ and $P' \sim \S
  \sim Q'$,
\item Whenever $Q \overset{\mu}{\rightarrow} Q'$ then, for some
  $P'$, $P \overset{\mu}{\rightarrow} P'$ and $P' \sim \S
  \sim Q'$.
\end{enumerate}
\end{definition}

\begin{theorem}
If $\mathcal{S}$ is a ``bisimulation up to $\sim$'', then
$\mathcal{S} \subseteq\;\sim$:
\begin{alltt}
\HOLthm{BisimulationUpto.STRONG_EQUIV_BY_BISIM_UPTO}\hfill{[STRONG_EQUIV_BY_BISIM_UPTO]}
\end{alltt}
\end{theorem}
Hence, to prove $P \sim Q$, one only needs to find a bisimulation
up to $\sim$ that contains $(P, Q)$.
%
For weak bisimilarity, the naive weak bisimulation up to weak bisimilarity
is unsound: if one simply replaces all occurrences of $\sim$ in
Def.~\ref{def:bisimUptoSim} with $\wb$, the resulting
``weak bisimulation up to'' relation need not be contained in weak
  bisimilarity ($\wb$)~\cite{PoSa2019}.
There are a few ways to fix this problem, and one is the following:
%
\begin{definition}%[Bisimulation up to $\approx$]
  \label{def:singleweak}
  $\S$ is a ``bisimulation up to $\approx$'' if
  $P\ \S\ Q$ implies, for all $\mu$,
\begin{enumerate}
\item Whenever $P \arr{\mu} P'$ then, for some
  $Q'$, $Q \Arcap{\mu} Q'$ and $P' \sim \S \approx Q'$,
\item Whenever $Q \arr{\mu} Q'$ then, for some
  $P'$, $P \Arcap{\mu} P'$ and $P' \approx \S \sim Q'$.
\end{enumerate}
Formally:
\begin{alltt}
\HOLthm[def,>>3]{BisimulationUpto.WEAK_BISIM_UPTO}
\end{alltt}
\end{definition}
Note that the HOL term corresponding to $\sim \R \wb$ is
``\HOLtm{WEAK_EQUIV O R O STRONG_EQUIV}'' where the order of
$\sim$ and $\approx$ seems reverted. This is because, in HOL
notation, the rightmost relation (\HOLtm{STRONG_EQUIV} or $\sim$) in the relational composition is
applied first.

\begin{theorem}
If $\mathcal{S}$ is a bisimulation up to $\approx$, then
$\mathcal{S} \subseteq\;\approx$:
\begin{alltt}
\HOLthm{BisimulationUpto.WEAK_EQUIV_BY_BISIM_UPTO}\hfill{[WEAK_EQUIV_BY_BISIM_UPTO]}
\end{alltt}
\end{theorem}

The above version of ``bisimulation up to $\wb$'' 
is not powerful enough for Milner's ``unique solution of equations''
theorem for $\wb$ (Theorem~\ref{t:Mil89}, see~\cite{sangiorgi1992problem} for more details).
The following version, with weak arrows, is
 used in the proof of Theorem~\ref{t:Mil89}:
\begin{definition}%[Bisimulation up to $\approx$ with weak arrows]
  \label{def:doubleweak}
$\mathcal{S}$ is a ``bisimulation up to $\approx$ with weak arrows'' if $P \;
  \mathcal{S} \; Q$ implies, for all $\mu$,
\begin{enumerate}
\item Whenever $P \Arr{\mu} P'$ then, for some $Q'$, $Q \Arcap{\mu} Q'$ and $P' \wb \S \wb Q'$,
\item Whenever $Q \Arr{\mu} Q'$ then, for some $P'$, $P \Arcap{\mu} P'$ and $P' \wb \S \wb Q'$.
\end{enumerate}
Formally:
\begin{alltt}
\HOLthm[def,>>3]{BisimulationUpto.WEAK_BISIM_UPTO_ALT}
\end{alltt}
\end{definition}

\begin{theorem}
If $\mathcal{S}$ is a bisimulation up to $\approx$ with weak arrows, then
$\mathcal{S} \subseteq\;\approx$:
\begin{alltt}
\HOLthm{BisimulationUpto.WEAK_EQUIV_BY_BISIM_UPTO_ALT}\hfill{[WEAK_EQUIV_BY_BISIM_UPTO_ALT]}
\end{alltt}
\end{theorem}

%  next file: coarsest.htex
