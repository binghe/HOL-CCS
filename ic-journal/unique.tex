\subsection{Systems of contractions}
\label{ss:SysContr}

A \emph{system of contractions} is defined as a system of equations,
except that the contraction symbol $\mcontr$ is used in the place of
the equality symbol $=$. Thus a system of contractions is a set 
$\{  X_i \mcontr E_i\}_{i\in I}$
where $I$ is an  indexing set and expressions
$E_i$  may contain the  \behavC\  variables 
$\{  X_i\}_{i\in I}$.

\begin{definition}
\label{d:uniContra}
Given a system of contractions 
$\{  X_i \mcontr E_i\}_{i\in I}$, 
 we say that:
\begin{itemize}
\item $\til P$ is a \emph{solution (for $\mcontrBIS$) of the 
 system of contractions} if $\til P \mcontrBIS \til E [\til P]$;
\item the system has \emph{a unique solution (for $\approx$)}
if $\til P \approx \til Q$ whenever $\til P$ and $\til Q$ are both solutions.
\end{itemize}
\end{definition}

The guardedness of contractions follows Def.~\ref{def:guardness} (for equations).
% \begin{definition}
% \label{d:guarded}
% A system of contractions $\{  X_i \mcontr E_i\}_{i\in I}$
%  is
% \emph{weakly guarded}
% if,  in each    $E_i$, each occurrence of
% a \behavC\ variable is underneath a prefix.

% The system use \emph{weakly-guarded sums} if 
% each $E_i$ only makes use of guarded sums.
% \end{definition}

\begin{lemma}
\label{l:uptocon}
Suppose $\til P$ and $\til Q$ are solutions  for $\mcontrBIS$
 of a system of weakly-guarded contractions that uses 
weakly-guarded sums.
For any context $\qct$  that uses 
weakly-guarded sums,
if  $\ct{\til P}\Arr{\mu}  R$,
 then 
there is a context $\qctp$  that uses 
weakly-guarded sums
such that $R \mcontrBIS \ctp{\til P}$ and $\ct{\til Q} \Arcap{\mu}
 \wb \ctp{\til Q}$.\footnote{There's no typo here: $\ct{\til Q} \Arcap{\mu} \wb \ctp{\til
     Q}$ means $\exists Q'.\; \ct{\til Q} \Arcap{\mu} Q'
   \wb \ctp{\til Q}$. Same as in Lemma~\ref{l:ruptocon}.}
\end{lemma}

\begin{proof}{(sketch from \cite{sangiorgi2017equations})}
Let $n$ be the length of the transition $\ct{\til P}\Arr\mu R$  (the
number of `strong steps' of which it is composed), and  
let $\ctpp {\til P}$ and $\ctpp {\til Q}$  be the processes obtained
from  $\ct {\til P}$ and $\ct {\til Q}$ by unfolding the definitions
of the contractions $n$ times. Thus in $\qctpp$ each hole is
underneath at least $n$ prefixes, and cannot contribute to an action
in the first $n$ transitions; moreover all the contexts have only
weakly-guarded sums.

We have $\ct{\til P} \mcontrBIS \ctpp{\til P}$, and 
$\ct{\til Q} \mcontrBIS \ctpp{\til Q}$, 
 by the substitutivity  properties of $\mcontrBIS$ (we exploit here
 the syntactic constraints on sums). Moreover,
 since each hole of the  context $\qctpp$ is underneath at least $n$
 prefixes, applying  
the definition
 of $ \mcontrBIS$ on the transition 
 $\ct{\til P}\Arr{\mu}  R$, we infer the existence
 of $\qctp$ such that 
$
\ctpp{\til P}\Arcap{\mu} \ctp{\til P} \mexpaBIS R
$
and 
$
\ctpp{\til Q}\Arcap{\mu}  \ctp{\til Q} 
. $
Finally, again applying the definition of $\mcontrBIS$ on 
$\ct{\til Q} \mcontrBIS \ctpp{\til Q}$, 
we derive 
$
\ct{\til Q}\Arcap{\mu}  \wb \ctp{\til Q} 
.$
\end{proof}

\begin{theorem}[unique solution of contractions~\cite{sangiorgi2017equations}] % for $\wb$
\label{t:contraBisimulationU} % Thm 3.10
%A system of weakly-guarded contractions
%having only weakly-guarded sums, has a unique solution for $\wb$.
\hl{Let the expressions $E_i$ ($i \in I$) contain at most the
  variables $X_i$ ($i \in I$), and let each $X_j$ ($j\in I$) be weakly
  guarded in each $E_i$. For any two groups of CCS processes $P_i$ and
  $Q_i$ ($i \in I$), if $\til P \mcontrBIS \til E\{\til P/\til X\}$ and
    $\til Q \mcontrBIS \til E\{\til Q/\til X\}$ then $\til P \wb \til Q$.}
\end{theorem}

\begin{proof}
\hl{We want to prove $P_i \wb Q_i$ ($i \in I$) by considering} the following relation
\begin{equation*}
%\label{eq:R}
\R \DSdefi \{(R,S) \st R \wb \ct{\til P}, S \wb \ct{\til Q} \mbox{~for some context
$\qct$ (weakly-guarded sum only)} \} \enspace.
\end{equation*}

\hl{Obviously we have $(P_i,Q_i) \in \R$ (by taking $C \equiv E_i$, and
the fact that $\mcontrBIS$ implies $\wb$). It remains to}
show that $\R$ is a bisimulation. Suppose \hl{$(R, S) \in \R$ via} a context
$C$. \hl{For any $R'$ such that $R \arr{\mu} R'$, we have to find a} $S'$ with $S \Arcap{\mu}
S'$ and $(R', S' \in \R$. From $R \wb C[{\til P}]$, we derive $C[{\til P}]
\Arcap{\mu} R'' \wb R'$ for some $R''$. Then by Lemma~\ref{l:uptocon},
there exists $C'$ with $R'' \mcontrBIS C'[{\til P}]$ and $C[{\til Q}]
\Arcap{\mu} S'' \wb C'[{\til Q}]$ for some $S''$. \hl{From $S \wb C[{\til
  Q}]$ and $C[{\til Q}] \Arcap{\mu} S''$, by induction and definition of $\wb$, it is not
hard to see that,}
there exists also $S'$ with $S \Arcap{\mu} S'$. This closes the
proof, as we have $R' \wb C'[{\til P}]$ and $S' \wb C'[{\til Q}]$ \hl{by
transitivity of $\wb$ and the fact that $\mcontrBIS$ implies $\wb$.
(The other side from $S$ follows in the same manner.)}
c.f. Fig.~\ref{fig:310} \hl{for a visual illustration.}
\end{proof}

\begin{figure}[ht]
\begin{displaymath}
  \xymatrix{
    {C[{\til P}]} \ar@{.}[r]^{\wb} \ar@{=>}[d]^{\widehat{\mu}} & {R} \ar@{-}[r]
    \ar@{->}[d]^{\mu} & {\R} \ar@{-}[r] & {S} \ar@{.}[r]^{\wb}
    \ar@{=>}[d]^{\widehat{\mu}} & {C[{\til Q}]} \ar@{=>}[d]^{\widehat{\mu}} \\
    {R''} \ar@{.}[d]_{\mcontrBIS} \ar@{.}[r]^{\wb} & {R'} \ar@{-}[r]
    \ar@{.}[ld]^{\wb} & {\R} \ar@{-}[r] & {S'} \ar@{.}[r]^{\wb} \ar@{.}[rd]_{\wb}
    & {S''} \ar@{.}[d]^{\wb} \\
    {C'[{\til P}]} & {} & {} & {} & {C'[{\til Q}]}
  }
\end{displaymath}
\caption{Proof illustration of Theorem~\ref{t:contraBisimulationU}
  (showing $\R$ is a bisimulation)}
\label{fig:310}
\end{figure}

\subsection{Rooted contraction}
\label{ss:new}

The unique solution theorem of Section~\ref{ss:SysContr} requires a
constrained syntax for sums, due to the congruence and precongruence
problems of bisimilarity and contraction with such operator. 
We show here that the constraints can be
removed by moving to the induced congruence and precongruence, the
latter called \emph{rooted contraction}:
\begin{definition}
\label{d:rcontra}
Two processes $P$ and $Q$ are in \emph{rooted contraction}, written as
 $P\rcontr Q$, if
\begin{enumerate}
\item $P \arr\mu P'$ implies that there is $Q'$ with $Q \arr \mu Q'$
 and $P'\mcontrBIS Q'$;
\item $Q \arr\mu Q'$   implies that there is $P'$ with $P \Arr \mu
 P'$ and $P' \wb Q'$\enspace.
\end{enumerate}
\end{definition}

%Above definition adapts the definition of rooted
%bisimilarity on top of that of the  contraction preorder
%$\mcontrBIS$.  %% Reviewer said this sentance is unclear. I too think so.

The precise formulation of  this definition was guided by the HOL theorem
prover and
the following two principles: (1) the definition should not be recursive,
along the lines of rooted bisimilarity
$\rapprox$ in Def.~\ref{d:rootedBisimilarity};
(2) the definition should  be built on top of existing \emph{contraction}
relation $\mcontrBIS$ (because of its completeness). 
A few other candidates were quickly tested and rejected, e.g.,
  because of  precongruence issue. The proof of the precongruence
 result below is along the lines of the analogous result
for rooted bisimilarity with respect to bisimilarity.

\begin{theorem}
\label{t:rcontrPrecongruence}
$\rcontr$ is a precongruence in CCS, and it is the
coarsest precongruence contained in $\contr$.
\end{theorem}  

For a system of rooted contractions, the meaning of 
``solution for $\rcontr$'' and of \emph{a unique solution for $\rapprox$}
is the expected one --- just replace in Def.~\ref{d:uniContra}  the preorder 
$\contr$ with $\rcontr$, and the equivalence 
$\approx$ with $\rapprox$ (note that with $\rapprox$ one considers
solutions with respect to  $\rcontr$).
%
For this new relation, the analogous of Lemma~\ref{l:uptocon} and of
Theorem~\ref{t:contraBisimulationU} can now be stated without constraints on the sum
operator.
The schema of the proofs is almost identical, because all 
properties of $\rcontr$ needed in this proof is its precongruence, which is
indeed true on unrestricted contexts including direct sums:
\begin{lemma}
\label{l:ruptocon}
Suppose $\til P$ and $\til Q$ are solutions  for $\rcontr$ 
 of a system of weakly-guarded
contractions.
For any context $\qct$, 
if  $\ct{\til P}\Arr{\mu}  R$,
 then 
there is a  context $\qctp$
such that $R \mcontrBIS \ctp{\til P}$ and  $\ct{\til Q} \Arr{\mu}
 \wb \ctp{\til Q}$.
\end{lemma}
The proof of Lemma~\ref{l:ruptocon} is exactly the same as of
Lemma~\ref{l:uptocon}, because all we need from $\mcontrBIS$ and
$\rcontr$ is their precongruences (in the sense of different
definitions of contexts). Also notice that, the conclusion of
Lemma~\ref{l:ruptocon} still uses $\mcontrBIS$, because $\rcontr$ does
not hold.

\begin{theorem}[Unique solution of \hl{rooted} contractions]
\label{t:rcontraBisimulationU}
%A system of weakly-guarded contractions has a unique solution for $\rapprox$. 
% (thus also for $\wb$).
\hl{Let the expressions $E_i$ ($i \in I$) contain at most the
  variables $X_i$ ($i \in I$), and let each $X_j$ ($j\in I$) be weakly
  guarded in each $E_i$. For any two groups of CCS processes $P_i$ and
  $Q_i$ ($i \in I$), if $\til P \rcontr \til E\{\til P/\til X\}$ and
    $\til Q \rcontr \til E\{\til Q/\til X\}$ then $\til P \rapprox \til Q$.}
\end{theorem}

\begin{proof}
\hl{We want to prove $P_i \rapprox Q_i$ ($i \in I$) by considering}
the following relation
\begin{equation*}
\R \DSdefi \{(R,S) \st R \wb \ct{\til P}, S \wb \ct{\til Q} \mbox{~for some context
$\qct$} \} \enspace.
\end{equation*}

Following the same steps in the proof of
Theorem~\ref{t:contraBisimulationU}
(using Lemma~\ref{l:ruptocon}
in place of Lemma~\ref{l:uptocon}), \hl{we can prove that $(P_i, Q_i)
\in\R$ and $\R$ is indeed a bisimulation. But this only shows $P_i \wb Q_i$.}
%
To further show $P_i \rapprox Q_i$, we appeal to
Lemma~\ref{l:obsCongrByWeakBisim}: \hl{for any $P'$ such that $P_i \arr{\mu} P'$, we have to
  find a $Q'$ with $Q_i \Arr{\mu} Q'$ and $(R',S') \in \R$.
%
From $P_i \rcontr E_i[{\til P}]$, by definition of $\rcontr$ we derive $E_i[{\til P}] \arr{\mu}
P''$ for some $P''$.} Then by Lemma 3.13 of~\citep[p.~102]{Mil89}
(c.f. also Lemma~\ref{lem:313} in Section~\ref{ss:part2}) \hl{there exists
a context
$C$ with $P'' = C[{\til P}]$ and $E_i[{\til Q}] \arr{\mu} C[{\til Q}]$.
From $Q_i \rcontr E_i[{\til Q}]$ and $E_i[{\til Q}] \arr{\mu} C[{\til
  Q}]$, by definition of $\rcontr$ we have $Q_i \Arr{\mu} Q'$ for some
$Q'$ and $Q' \wb C[{\til Q}]$. This closes the proof, as we have
$P' \wb C[{\til P}]$ (by the fact that $\mcontrBIS$ implies $\wb$) and
$Q' \wb C[{\til Q}]$. (The other side from $Q_i$ follows in the same manner.)}
c.f. Fig.~\ref{fig:314} \hl{for a visual illustration.}
\end{proof}

\begin{figure}[ht]
\begin{displaymath}
  \xymatrix{
    {E_i[{\til P}]} \ar@{.}[r]^{\preceq^{\mathrm{c}}_{\mathrm{bis}}} \ar@{->}[d]^{\mu} & {P_i} \ar@{-}[r]
    \ar@{->}[d]^{\mu} & {\R} \ar@{-}[r] & {Q_i} \ar@{.}[r]^{\rcontr}
    \ar@{=>}[d]^{\mu} & {E_i[{\til Q}]} \ar@{->}[d]^{\mu} \\
    {C[{\til P}] = P''} \ar@{.}[r]^{\qquad\preceq_{\mathrm{bis}}} & {P'} \ar@{-}[r] & {\R} \ar@{-}[r] & {Q'} \ar@{.}[r]^{\wb} 
    & {C[{\til Q}]} \\
  }
\end{displaymath}
\caption{Proof illustration of Theorem~\ref{t:rcontraBisimulationU}
  (showing $P_i \rapprox Q_i$)}
\label{fig:314}
\end{figure}
